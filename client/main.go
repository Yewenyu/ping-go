package main

/*
#include <stdio.h>
#include <stdlib.h>
*/
import "C"
import (
	"encoding/json"
	"fmt"
	"net/http"
	"runtime/debug"
	"strings"
	"time"

	_ "net/http/pprof"

	goPing "github.com/Yewenyu/ping-go"
)

//export startPing
func startPing(hosts *C.char, pingCount int) *C.char {
	ss := C.GoString(hosts)
	var h = strings.Split(ss, ",")
	statam := goPing.StartPings(h, pingCount)
	if len(statam) == 0 {
		return nil
	}

	mapv := make(map[string]interface{})
	for key, v := range statam {
		jsonStr, err := json.Marshal(v)
		if err == nil {
			mapv[key] = string(jsonStr)
		}

	}
	str, e := json.Marshal(mapv)
	if e != nil {
		return nil
	}
	var s = string(str)
	debug.FreeOSMemory()
	return C.CString(s)
}

//export startTcpPing
func startTcpPing(addrs *C.char, pingCount int, timeout int, interval int,groupCount int, checkAlive bool) *C.char {
	ss := C.GoString(addrs)
	var h = strings.Split(ss, ",")
	result := goPing.StartTcpPings(h, pingCount, timeout, interval,groupCount, checkAlive)
	mapv := make(map[string]interface{})
	for _, r := range result {
		jsonStr, err := json.Marshal(r)
		if err == nil {
			mapv[r.Host] = string(jsonStr)
		}

	}
	str, e := json.Marshal(mapv)
	if e != nil {
		return nil
	}
	var s = string(str)
	debug.FreeOSMemory()
	return C.CString(s)
}
func main() {

	// ss := goPing.StartPings([]string{"www.baidu.com", "www.qq.com"}, 3)
	go func() {
		var success = 0
		var loss = 0
		var err1,err2,err3 int
		fmt.Println(time.Now().String())
		vs := goPing.StartTcpPings(stringss, 1, 5, 1,10, true)
		for _,v := range vs{
			if v.Loss == 0{
				success += 1
			}else{
				loss += 1
			}
			if v.ErrType == 1{
				err1 += 1
			}
			if v.ErrType == 2{
				err2 += 1
			}
			if v.ErrType == 3{
				err3 += 1
			}
			
		}
		fmt.Println("%s\n,%s", time.Now().String(), "ss")
	}()

	http.ListenAndServe("0.0.0.0:6060", nil)
}
var stringss = []string{"134.209.144.116:8003", "144.126.148.229:8003", "45.128.53.25:8003", "23.152.226.87:8003", "5.181.124.35:8003", "103.83.159.154:8003", "103.83.158.87:8003", "66.187.5.155:8003", "66.187.4.228:8003", "66.187.5.181:8003", "66.187.5.185:8003", "23.152.226.40:8003", "103.144.176.245:8003", "103.144.176.247:8003", "103.83.156.165:8003", "103.83.158.226:8003", "159.89.137.180:8003", "128.199.119.89:8003", "45.88.42.58:8003", "172.104.188.95:8003", "134.122.44.222:8003", "5.189.223.141:8003", "139.162.107.123:8003", "144.91.117.70:8003", "172.104.70.220:8003", "88.80.184.212:8003", "92.38.135.129:8003", "92.38.135.181:8003", "5.188.36.19:8003", "5.188.168.34:8003", "185.136.206.55:8003", "18.141.176.99:8003", "172.104.207.160:8003", "194.195.112.24:8003", "143.110.185.154:8003", "185.105.1.199:8003", "216.10.243.183:8003", "13.233.51.238:8003", "65.0.86.193:8003", "109.166.36.5:8003", "45.11.1.102:8003", "5.180.77.231:8003", "45.14.70.221:8003", "45.14.70.144:8003", "109.166.38.187:8003", "5.180.77.84:8003", "103.29.68.189:8003", "103.44.61.85:8003", "103.44.61.181:8003", "5.181.4.34:8003", "103.253.43.210:8003", "91.245.255.122:8003", "193.239.86.142:8003", "43.225.100.11:8003", "103.44.61.86:8003", "103.44.61.6:8003", "103.44.61.15:8003", "167.114.185.207:8003", "198.100.154.218:8003", "5.149.252.19:8003", "54.39.83.164:8003", "23.154.81.102:8003", "23.133.64.79:8003", "66.94.109.244:8003", "66.94.109.242:8003", "138.68.20.142:8003", "209.141.32.198:8003", "194.76.137.105:8003", "194.76.137.68:8003", "31.13.213.21:8003", "194.53.111.197:8003", "185.183.87.129:8003", "185.250.151.122:8003", "192.227.143.164:8003", "92.38.176.36:8003", "92.38.133.98:8003", "66.187.5.137:8003", "45.15.161.183:8003", "45.15.161.73:8003", "89.43.109.162:8003", "103.144.176.219:8003", "23.152.226.89:8003", "209.126.86.53:8003", "209.126.87.49:8003", "144.126.130.221:8003", "88.218.200.121:8003", "88.218.200.122:8003", "66.94.115.147:8003", "66.94.115.149:8003", "51.195.118.130:8003", "135.125.133.219:8003", "51.195.42.231:8003", "51.68.191.199:8003", "135.125.161.185:8003", "135.125.161.22:8003", "135.125.239.170:8003", "94.237.31.193:8003", "94.237.98.255:8003", "94.237.95.229:8003", "94.237.95.229:8003", "94.237.31.8:8003", "46.101.241.68:8003", "45.32.155.73:8003", "116.202.105.154:8003", "94.130.180.131:8003", "194.163.155.208:8003", "194.163.155.181:8003", "194.163.156.8:8003", "161.97.69.117:8003", "161.97.69.61:8003", "161.97.69.96:8003", "185.207.250.67:8003", "161.97.69.68:8003", "185.207.250.69:8003", "185.207.250.70:8003", "185.207.250.71:8003", "185.207.250.68:8003", "5.188.70.85:8003", "79.133.120.54:8003", "79.133.120.153:8003", "5.196.27.200:8003", "54.37.18.84:8003", "92.223.59.46:8003", "5.181.27.38:8003", "51.38.80.242:8003", "83.136.251.5:8003", "165.232.109.161:8003", "92.223.59.150:8003", "92.223.59.36:8003", "62.216.95.169:8003", "194.187.248.80:8003", "5.188.226.72:8003", "92.223.79.45:8003", "92.223.93.249:8003", "92.38.171.82:8003", "92.38.171.107:8003", "5.183.103.178:8003", "5.183.103.138:8003", "5.183.103.151:8003", "5.183.103.201:8003", "92.38.171.215:8003", "5.183.103.205:8003", "192.46.213.213:8003", "172.105.63.93:8003", "5.188.228.214:8003", "185.105.1.185:8003", "185.105.1.146:8003", "95.85.71.36:8003", "13.233.183.110:8003", "45.88.42.111:8003", "139.99.61.150:8003", "51.79.240.247:8003", "172.104.54.34:8003", "159.223.67.248:8003", "51.79.254.178:8003", "45.88.42.171:8003", "5.180.78.200:8003", "194.233.85.126:8003", "194.233.85.130:8003", "194.233.85.121:8003", "194.233.85.131:8003", "194.233.85.129:8003", "194.233.85.117:8003", "194.233.85.116:8003", "194.233.85.128:8003", "139.59.117.227:8003", "157.245.144.57:8003", "157.245.55.198:8003", "51.79.161.72:8003", "51.79.161.10:8003", "5.180.78.202:8003", "45.88.42.132:8003", "95.111.193.152:8003", "94.237.3.218:8003", "94.237.64.102:8003", "94.237.75.5:8003", "94.237.77.7:8003", "95.111.197.138:8003", "94.237.67.212:8003", "5.183.101.18:8003", "5.183.101.33:8003", "5.183.101.25:8003", "5.183.101.16:8003", "5.183.101.126:8003", "5.183.101.107:8003", "194.195.120.219:8003", "139.99.194.223:8003", "51.161.134.213:8003", "203.57.51.244:8003", "45.124.54.87:8003", "203.29.243.172:8003", "213.156.142.76:8003", "5.188.36.7:8003", "5.188.36.199:8003", "5.188.168.196:8003", "92.38.135.103:8003", "92.38.135.174:8003", "92.38.160.64:8003", "92.38.135.251:8003", "92.38.160.4:8003", "92.38.160.78:8003", "92.38.160.79:8003", "5.180.79.228:8003", "193.203.202.13:8003", "5.188.6.244:8003", "95.85.72.146:8003", "95.85.72.147:8003", "5.188.108.185:8003", "5.22.222.28:8003", "5.22.222.30:8003", "5.22.222.29:8003", "5.22.222.34:8003", "5.22.222.38:8003", "5.22.222.39:8003", "5.22.222.40:8003", "5.22.222.36:8003", "5.22.222.37:8003", "185.189.149.147:8003", "45.90.57.26:8003", "109.230.199.233:8003", "195.123.245.201:8003", "45.142.215.183:8003", "78.142.244.58:8003", "109.248.19.133:8003", "109.248.19.134:8003", "41.215.240.130:8003", "92.38.139.232:8003", "92.223.109.179:8003", "92.223.65.196:8003", "185.144.29.86:8003", "92.38.139.220:8003", "146.185.218.203:8003", "146.185.218.199:8003", "185.51.134.14:8003", "5.188.4.88:8003", "5.188.238.85:8003", "213.156.143.161:8003", "79.133.43.62:8003", "146.185.219.110:8003", "5.183.100.76:8003", "5.183.100.14:8003", "5.183.100.50:8003", "5.183.100.184:8003", "102.223.73.204:8003", "193.239.178.18:8003", "5.188.133.136:8003", "185.225.69.48:8003", "103.84.193.228:8003", "103.153.254.178:8003", "89.43.111.243:8003", "185.123.53.230:8003", "65.21.151.66:8003", "95.217.132.102:8003", "65.21.145.66:8003", "65.21.144.84:8003", "65.21.107.86:8003", "45.133.192.19:8003", "193.36.118.22:8003", "45.128.133.116:8003", "77.81.139.134:8003", "185.82.217.24:8003", "185.99.133.173:8003", "200.14.81.133:8003", "200.55.240.234:8003", "60.249.20.182:8003", "60.249.21.51:8003", "191.96.145.78:8003", "213.156.157.11:8003", "91.223.208.183:8003", "109.169.72.48:8003", "103.91.67.122:8003", "123.253.33.170:8003", "45.95.11.120:8003", "195.80.150.22:8003", "152.89.160.79:8003", "213.156.137.118:8003", "94.46.171.187:8003", "185.105.3.64:8003", "190.10.8.48:8003", "185.62.75.27:8003", "103.152.255.129:8003", "190.120.229.11:8003", "190.120.231.28:8003", "45.138.86.15:8003", "45.138.86.10:8003"}